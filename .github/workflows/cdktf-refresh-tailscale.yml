---
name: CDKTF Refresh Tailscale

on:
  workflow_dispatch:

permissions:
  contents: read

env:
  CDKTF_VERSION: 0.14.3
  TERRAFORM_VERSION: 1.3.5
  NODE_VERSION: latest

jobs:
  terraform:
    name: "Terraform CDK Refresh Tailscale"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@8ade135a41bc03ea155e62e844d188df1ea18608 # v4
        with:
          persist-credentials: false
      # Configure 1Password Service Account
      - name: Configure 1Password Service Account
        uses: 1Password/load-secrets-action/configure@d1a4e73495bde3551cf63f6c048588b8f734e21d # v1
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
      # Fetch TERRAFORM_CLOUD_TOKEN from 1Password using load-secrets-action
      - name: Fetch TERRAFORM_CLOUD_TOKEN from 1Password
        uses: 1Password/load-secrets-action@d1a4e73495bde3551cf63f6c048588b8f734e21d # v1
        id: fetch-terraform-cloud-token
        with:
          export-env: false
        env:
          TERRAFORM_CLOUD_TOKEN: op://Infrastructure/terraform/cloud/token
      - name: Install Terraform
        uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1 # v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          cli_config_credentials_token: ${{ steps.fetch-terraform-cloud-token.outputs.TERRAFORM_CLOUD_TOKEN }}
      - name: Setup yarn
        uses: actions/setup-node@5e21ff4d9bc1a8cf6de233a3057d20ec6b3fb69d # v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn
          cache-dependency-path: ./cdktf/yarn.lock
      - name: Install dependencies
        working-directory: ./cdktf
        run: |
          # Install node-gyp globally first
          npm install -g node-gyp

          yarn install --frozen-lockfile --immutable
      - name: Generate module and provider bindings
        working-directory: ./cdktf
        env:
          TERRAFORM_CLOUD_TOKEN: ${{ steps.fetch-terraform-cloud-token.outputs.TERRAFORM_CLOUD_TOKEN }}
        run: yarn get
      - name: Synth Terraform CDK
        working-directory: ./cdktf
        env:
          TERRAFORM_CLOUD_TOKEN: ${{ steps.fetch-terraform-cloud-token.outputs.TERRAFORM_CLOUD_TOKEN }}
        run: yarn synth
      - name: Remove tailscale from state
        working-directory: ./cdktf
        env:
          TERRAFORM_CLOUD_TOKEN: ${{ steps.fetch-terraform-cloud-token.outputs.TERRAFORM_CLOUD_TOKEN }}
        run: yarn remove-tailscale
