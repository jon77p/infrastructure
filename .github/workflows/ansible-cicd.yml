---
name: Ansible CI/CD
on:
  push:
    branches:
      - main
    paths:
      - 'ansible/host_vars/**'
  pull_request:
    branches:
      - main
    paths:
      - 'ansible/host_vars/**'
  workflow_dispatch:
    inputs:
      host:
        description: 'Host to run Ansible against'
        required: true
        type: choice
        options:
          - "allaboutsecurity"
          - "codeserver"
          - "firefly"
          - "gaming"
          - "gaps"
          - "healthchecks"
          - "innernet"
          - "monitoring"
          - "nextcloud"
          - "nodered"
          - "pihole"
          - "securemylife"
          - "timemachine"
          - "vault"
          - "youtubedl"
      dry_run:
        description: 'Dry run'
        required: true
        type: boolean
        default: true
jobs:
  setup:
    runs-on: ubuntu-latest
    outputs:
      host: ${{ steps.set-host.outputs.host }}
      dry_run: ${{ steps.set-dry-run.outputs.dry_run }}
    steps:
      - name: Checkout (pull_request)
        uses: actions/checkout@v2
        if: github.event_name == 'pull_request'
        with:
          ref: ${{ github.event.pull_request.head.sha }}
      - name: Checkout (workflow_dispatch || push)
        uses: actions/checkout@v2
        if: github.event_name != 'pull_request'
      - name: Fetch main branch
        run: git fetch origin main
      - name: Set host
        id: set-host
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "host=${{ github.event.inputs.host }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            # Get list of subdirectories in ansible/host_vars that have changed
            CHANGED_HOSTS=$(git diff --name-only origin/main | grep -oP 'ansible/host_vars/\K[^/]+')
            # Set host to list of changed hosts
            echo "host=${CHANGED_HOSTS}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            # Get list of subdirectories in ansible/host_vars that have changed
            CHANGED_HOSTS=$(git diff --name-only origin/main | grep -oP 'ansible/host_vars/\K[^/]+')
            # Set host to list of changed hosts
            echo "host=${CHANGED_HOSTS}" >> $GITHUB_OUTPUT
          else
            echo "Unknown event name: ${{ github.event_name }}"
            exit 1
          fi
      - name: Set dry run (workflow_dispatch)
        id: set-dry-run
        run: |
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            echo "dry_run=${{ github.event.inputs.dry_run }}" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "pull_request" ]; then
            echo "dry_run=true" >> $GITHUB_OUTPUT
          elif [ "${{ github.event_name }}" == "push" ]; then
            echo "dry_run=false" >> $GITHUB_OUTPUT
          else
            echo "Unknown event name: ${{ github.event_name }}"
            exit 1
          fi
      - name: Summary
        run: |
          echo "# Inputs Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Input | Value |" >> $GITHUB_STEP_SUMMARY
          echo "| --- | --- |" >> $GITHUB_STEP_SUMMARY
          echo "| host | ${{ steps.set-host.outputs.host }} |" >> $GITHUB_STEP_SUMMARY
          echo "| dry_run | ${{ steps.set-dry-run.outputs.dry_run }} |" >> $GITHUB_STEP_SUMMARY

  ansible:
    runs-on: ubuntu-latest
    needs: setup
    steps:
      - name: Checkout
        uses: actions/checkout@v2
      - name: Setup Tailscale
        uses: tailscale/github-action@v1
        with:
          authkey: ${{ secrets.TAILSCALE_AUTHKEY }}
      - name: Setup Taskfile
        uses: arduino/setup-task@v1
        with:
          repo-token: ${{ secrets.GITHUB_TOKEN }}
      - name: Setup Python
        uses: actions/setup-python@v2
        with:
          python-version: 3.9
      - name: Setup CICD
        run: task setup-cicd
      # Loop through hosts
      - name: Run Ansible
        run: |
          echo "# Ansible Summary" >> $GITHUB_STEP_SUMMARY
          echo "| Host | Status |" >> $GITHUB_STEP_SUMMARY

          FINAL_STATUS=0

          for host in ${{ needs.setup.outputs.host }}; do
            STATUS_EMOJI=""

            if ! ansible --list-hosts all | grep -q $host; then
              echo "$host is not an available host, skipping"
              continue
            fi

            echo ::group::Pinging $host
            HOST=$host task ansible-ping
            STATUS_PING=$?
            echo ::endgroup::

            if [ $STATUS_PING -ne 0 ]; then
              STATUS_EMOJI=":warning:"
              echo "$host is unreachable, skipping"
            else
              echo ::group::Running Ansible for $host
              HOST=$host DRY_RUN=${{ needs.setup.outputs.dry_run }} task ansible
              STATUS=$?
              echo ::endgroup::

              if [ $STATUS -ne 0 ]; then
                FINAL_STATUS=$STATUS
              fi

              if [ $STATUS -eq 0 ]; then
                STATUS_EMOJI=":white_check_mark:"
              else
                STATUS_EMOJI=":x:"
              fi
            fi

            echo "| $host | $STATUS_EMOJI |" >> $GITHUB_STEP_SUMMARY
          done

          exit $FINAL_STATUS
