---
name: CDKTF Deployment

on:
  push:
    branches:
      - main
    paths:
      - cdktf/**
  workflow_dispatch:

permissions:
  contents: read
  pull-requests: write
  issues: read

env:
  CDKTF_VERSION: 0.14.3
  TERRAFORM_VERSION: 1.3.5
  NODE_VERSION: latest

jobs:
  terraform:
    name: "Terraform CDK Deploy"
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@c85c95e3d7251135ab7dc9ce3241c5835cc595a9 # v3
        with:
          persist-credentials: false
      # Configure 1Password Service Account
      - name: Configure 1Password Service Account
        uses: 1Password/load-secrets-action/configure@d1a4e73495bde3551cf63f6c048588b8f734e21d # v1
        with:
          service-account-token: ${{ secrets.OP_SERVICE_ACCOUNT_TOKEN }}
      # Fetch TERRAFORM_CLOUD_TOKEN from 1Password using load-secrets-action
      - name: Fetch TERRAFORM_CLOUD_TOKEN from 1Password
        uses: 1Password/load-secrets-action@d1a4e73495bde3551cf63f6c048588b8f734e21d # v1
        id: fetch-terraform-cloud-token
        with:
          export-env: false
        env:
          TERRAFORM_CLOUD_TOKEN: op://Infrastructure/terraform/cloud/token
      - name: Install Terraform
        uses: hashicorp/setup-terraform@633666f66e0061ca3b725c73b2ec20cd13a8fdd1 # v2
        with:
          terraform_version: ${{ env.TERRAFORM_VERSION }}
          terraform_wrapper: false
          cli_config_credentials_token: ${{ steps.fetch-terraform-cloud-token.outputs.TERRAFORM_CLOUD_TOKEN }}
      - name: Setup yarn
        uses: actions/setup-node@e33196f7422957bea03ed53f6fbb155025ffc7b8 # v3
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: yarn
          cache-dependency-path: ./cdktf/yarn.lock
      - name: Install dependencies
        working-directory: ./cdktf
        run: |
          # Install node-gyp globally first
          npm install -g node-gyp

          yarn install --frozen-lockfile --immutable
      - name: Generate module and provider bindings
        working-directory: ./cdktf
        env:
          TERRAFORM_CLOUD_TOKEN: ${{ steps.fetch-terraform-cloud-token.outputs.TERRAFORM_CLOUD_TOKEN }}
        run: yarn get
      - name: Run Terraform CDK
        uses: hashicorp/terraform-cdk-action@6b19d05fa4efedee6d780c79689af9c21b7e04de # v0.1.28
        with:
          terraformVersion: ${{ env.TERRAFORM_VERSION }}
          cdktfVersion: ${{ env.CDKTF_VERSION }}
          workingDirectory: ./cdktf
          stackName: cdktf
          mode: auto-approve-apply
          terraformCloudToken: ${{ secrets.TERRAFORM_CLOUD_TOKEN }}
          githubToken: ${{ secrets.GITHUB_TOKEN }}
      - name: Store generated CDKTF
        uses: actions/upload-artifact@0b7f8abb1508181956e8e162db84b466c27e18ce # v3
        if: always()
        with:
          name: cdktf
          path: cdktf/cdktf.out/
          retention-days: 5
