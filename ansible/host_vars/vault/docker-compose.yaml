---
version: '3.4'
services:
  vault:
    image: vault:latest@sha256:d45ffca3b9bc5f15f665c0afb581de668bca935ff1fffa10049648183c80ef6f
    volumes:
      - "{{ docker_volume_dirs.vault[0] }}:/vault/config"
      - "{{ docker_volume_dirs.vault[1] }}:/vault/file"
      - "{{ docker_volume_dirs.vault[2] }}:/vault/logs"
      - "{{ docker_volume_dirs.vault[3] }}:/vault/plugins"
    ports:
      - "{{ vault.port }}:{{ vault.internal_port }}"
    cap_add:
      - "IPC_LOCK"
    restart: "always"
    command: ["vault", "server", "-config", "/vault/config/config.hcl"]
    healthcheck:
      test: ["CMD", "wget", "https://healthchecks.{{ domain }}/ping/{{ vault.healthcheck }}", "-O", "/dev/null"]
      timeout: 45s
      interval: 10s
      retries: 5
  opconnect_api:
    image: 1password/connect-api:latest@sha256:2b84ec5c436c2b743b18b48cabe8e176b897c472aa5b3ad57336d885bd964b72
    volumes:
      - "{{ docker_volume_dirs.opconnect[0] }}/1password-credentials.json:/home/opuser/.op/1password-credentials.json"
      - "data:/home/opuser/.op/data"
    ports:
      - "{{ opconnect.api.port }}:{{ opconnect.api.internal_port }}"
    restart: "always"
  opconnect_sync:
    image: 1password/connect-sync:latest@sha256:9dc92b60bf19c0a51aca9f69b27b8d5e8a6716ebe06a787bfbbd6d1c60398b03
    volumes:
      - "{{ docker_volume_dirs.opconnect[0] }}/1password-credentials.json:/home/opuser/.op/1password-credentials.json"
      - "data:/home/opuser/.op/data"
    ports:
      - "{{ opconnect.sync.port }}:{{ opconnect.sync.internal_port }}"
    restart: "always"
  promtail:
    image: grafana/promtail:latest
    restart: "always"
    volumes:
      - "/var/log/cloudflared.log:/var/log/cloudflared.log:ro"
      - "/var/log/journal:/var/log/journal:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "{{ docker_volume_dirs.promtail[0] }}/config.yaml:/etc/promtail/config.yaml"
    command: "-config.file=/etc/promtail/config.yaml"

volumes:
  data:
