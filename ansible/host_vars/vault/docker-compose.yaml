---
version: "3.4"
services:
  vault:
    image: vault:latest@sha256:403c4cdc39091f58dd804133b8f1f3cc933e1a3929bd64eab50443d4557e3ee8
    volumes:
      - "{{ docker_volume_dirs.vault[0] }}:/vault/config"
      - "{{ docker_volume_dirs.vault[1] }}:/vault/file"
      - "{{ docker_volume_dirs.vault[2] }}:/vault/logs"
      - "{{ docker_volume_dirs.vault[3] }}:/vault/plugins"
    ports:
      - "{{ vault.port }}:{{ vault.internal_port }}"
    cap_add:
      - IPC_LOCK
    restart: always
    command: [vault, server, -config, /vault/config/config.hcl]
    healthcheck:
      test: [CMD, wget, "https://healthchecks.{{ domain }}/ping/{{ vault.healthcheck }}", -O, /dev/null]
      timeout: 45s
      interval: 10s
      retries: 5
  opconnect_api:
    image: 1password/connect-api:latest@sha256:215416a986773b1a238e9c044e9e3e8b5c042742a8c6741d081288dff55a8779
    volumes:
      - "{{ docker_volume_dirs.opconnect[0] }}/1password-credentials.json:/home/opuser/.op/1password-credentials.json"
      - data:/home/opuser/.op/data
    ports:
      - "{{ opconnect.api.port }}:{{ opconnect.api.internal_port }}"
    restart: always
  opconnect_sync:
    image: 1password/connect-sync:latest@sha256:48b3de2a1a1b0eea41f43a6958f7748a6d416e08575f834a09e2fbfdee58800a
    volumes:
      - "{{ docker_volume_dirs.opconnect[0] }}/1password-credentials.json:/home/opuser/.op/1password-credentials.json"
      - data:/home/opuser/.op/data
    ports:
      - "{{ opconnect.sync.port }}:{{ opconnect.sync.internal_port }}"
    restart: always
  promtail:
    image: grafana/promtail:latest@sha256:c16c710f7333411a1a788842ec9967e26577053ff0c0dff41a8d9a6ea0b95c2b
    restart: always
    volumes:
      - /var/log/cloudflared.log:/var/log/cloudflared.log:ro
      - /var/log/journal:/var/log/journal:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{ docker_volume_dirs.promtail[0] }}/config.yaml:/etc/promtail/config.yaml"
    command: -config.file=/etc/promtail/config.yaml

volumes:
  data:
