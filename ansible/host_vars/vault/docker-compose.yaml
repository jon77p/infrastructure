---
version: '3.4'
services:
  vault:
    image: vault:latest
    volumes:
      - "{{ docker_volume_dirs[0] }}:/vault/config"
      - "{{ docker_volume_dirs[1] }}:/vault/file"
      - "{{ docker_volume_dirs[2] }}:/vault/logs"
      - "{{ docker_volume_dirs[3] }}:/vault/plugins"
    ports:
      - "{{ compose_project_ports[0] }}:8200"
    cap_add:
      - "IPC_LOCK"
    restart: "always"
    command: ["vault", "server", "-config", "/vault/config/config.hcl"]
    healthcheck:
      test: ["CMD", "wget", "https://healthchecks.{{ domain }}/ping/{{ opconnect_results['vault'].healthcheck }}", "-O", "/dev/null"]
      timeout: 45s
      interval: 10s
      retries: 5
  opconnect_api:
    image: 1password/connect-api:latest
    volumes:
      - "{{ docker_volume_dirs[4] }}/1password-credentials.json:/home/opuser/.op/1password-credentials.json"
      - "data:/home/opuser/.op/data"
    ports:
      - "{{ op_connect_ports[0] }}:8080"
    restart: "always"
  opconnect_sync:
    image: 1password/connect-sync:latest
    volumes:
      - "{{ docker_volume_dirs[4] }}/1password-credentials.json:/home/opuser/.op/1password-credentials.json"
      - "data:/home/opuser/.op/data"
    ports:
      - "{{ op_connect_ports[1] }}:8080"
    restart: "always"
volumes:
  data:
