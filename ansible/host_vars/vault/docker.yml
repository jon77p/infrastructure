---
compose_project_name: "vault"
compose_project_ports:
  - "8200"
op_connect_ports:
  - "8080"
  - "8081"
docker_volume_dirs:
  - "/mnt/{{ compose_project_name }}/config"
  - "/mnt/{{ compose_project_name }}/file"
  - "/mnt/{{ compose_project_name }}/logs"
  - "/mnt/{{ compose_project_name }}/plugins"
  - "/mnt/op-connect"
compose_definition:
  version: '3.4'
  services:
    vault:
      image: vault:latest
      volumes:
        - "{{ docker_volume_dirs[0] }}:/vault/config"
        - "{{ docker_volume_dirs[1] }}:/vault/file"
        - "{{ docker_volume_dirs[2] }}:/vault/logs"
        - "{{ docker_volume_dirs[3] }}:/vault/plugins"
      ports:
        - "{{ compose_project_ports[0] }}:8200"
      cap_add:
        - "IPC_LOCK"
      restart: "always"
      command: ["vault", "server", "-config", "/vault/config/config.hcl"]
      healthcheck:
        test: ["CMD", "wget", "https://healthchecks.{{ domain }}/ping/{{ healthcheck_uuids[inventory_hostname].healthcheck }}", "-O", "/dev/null"]
        timeout: 45s
        interval: 10s
        retries: 5
    op-connect-api:
      image: 1password/connect-api:latest
      volumes:
        - "{{ docker_volume_dirs[4] }}/1password-credentials.json:/home/opuser/.op/1password-credentials.json"
        - "data:/home/opuser/.op/data"
      ports:
        - "{{ op_connect_ports[0] }}:8080"
      restart: "always"
    op-connect-sync:
      image: 1password/connect-sync:latest
      volumes:
        - "{{ docker_volume_dirs[4] }}/1password-credentials.json:/home/opuser/.op/1password-credentials.json"
        - "data:/home/opuser/.op/data"
      ports:
        - "{{ op_connect_ports[1] }}:8080"
      restart: "always"
  volumes:
    data:
