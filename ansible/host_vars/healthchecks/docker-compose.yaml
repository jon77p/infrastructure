---
version: '3'
services:
  healthchecks:
    image: linuxserver/healthchecks:latest@sha256:f01852094a8667a79e97b27f4484ffd8cf97171de5dd1df6f6a54929660545f2
    volumes:
      - "{{ docker_volume_dirs.healthchecks[0] }}:/config"
    ports:
      - "{{ compose_project_port }}:8000"
    environment:
      SITE_ROOT: "https://healthchecks.{{ domain }}"
      SITE_NAME: "Healthchecks"
      SITE_LOGO_URL: "https://healthchecks.io/static/img/logo-rounded.svg"
      DEFAULT_FROM_EMAIL: "healthchecks@{{ domain }}"
      EMAIL_HOST: "{{ healthchecks.email.host }}"
      EMAIL_PORT: "{{ healthchecks.email.port }}"
      EMAIL_HOST_USER: "{{ healthchecks.email.username }}"
      EMAIL_HOST_PASSWORD: "{{ healthchecks.email.password }}"
      EMAIL_USE_TLS: "{{ healthchecks.email.use_tls | string() }}"
      SUPERUSER_EMAIL: "{{ healthchecks.superuser.email }}"
      SUPERUSER_PASSWORD: "{{ healthchecks.superuser.password }}"
    restart: "always"
    healthcheck:
      test: ["CMD", "wget", "https://hc-ping.com/{{ healthchecks.healthcheck }}", "-O", "/dev/null"]
      timeout: 45s
      interval: 10s
      retries: 5
  promtail:
    image: grafana/promtail:latest
    restart: "always"
    volumes:
      - "/var/log/cloudflared.log:/var/log/cloudflared.log:ro"
      - "/var/log/journal:/var/log/journal:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "{{ docker_volume_dirs.promtail[0] }}/config.yaml:/etc/promtail/config.yaml"
    command: "-config.file=/etc/promtail/config.yaml"
  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    restart: "always"
    ports:
      - "{{ node_exporter.port }}:{{ node_exporter.internal_port }}"
    command:
      - "--path.rootfs=/host"
      - "--collector.systemd"
      - "--collector.processes"
    pid: host
    volumes:
      - "/:/host:ro,rslave"
  cadvisor:
    image: zcube/cadvisor:latest
    restart: "always"
    ports:
      - "{{ cadvisor.port }}:{{ cadvisor.internal_port }}"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro
