---
version: '3.8'
services:
  firefly:
    image: fireflyiii/core:latest@sha256:2dfdd46cb1bba3d87f0046381928d6e2422eb6999e5f15047250fe57f8b68f6d
    volumes:
      - "{{ docker_volume_dirs[0] }}:/var/www/html/storage/upload"
    environment:
      SITE_OWNER: "{{ firefly.site_owner }}"
      APP_KEY: "{{ firefly.app_key }}"
      TRUSTED_PROXIES: "{{ firefly.trusted_proxies }}"
      DB_CONNECTION: "mysql"
      DB_HOST: "fireflydb"
      DB_PORT: "{{ fireflydb.port }}"
      DB_DATABASE: "{{ fireflydb.database }}"
      DB_USERNAME: "{{ fireflydb.username }}"
      DB_PASSWORD: "{{ fireflydb.password }}"
      COOKIE_DOMAIN: "{{ domain }}"
      MAIL_MAILER: "log"
      MAIL_HOST: "{{ firefly.mail.host }}"
      MAIL_PORT: "{{ firefly.mail.port }}"
      MAIL_FROM: "{{ firefly.mail.from }}"
      MAIL_USERNAME: "{{ firefly.mail.username }}"
      MAIL_PASSWORD: "{{ firefly.mail.password }}"
      MAIL_ENCRYPTION: "{{ firefly.mail.encryption }}"
      SEND_REGISTRATION_MAIL: "{{ firefly.mail.send_registration }}"
      APP_NAME: "FireflyIII"
      APP_URL: "http://localhost"
    depends_on:
      - "fireflydb"
    networks:
      - "firefly"
      - "web"
    ports:
      - "{{ firefly.port }}:8080"
    restart: "always"
    healthcheck:
      test: ["CMD", "curl", "https://healthchecks.{{ domain }}/ping/{{ firefly.healthcheck }}"]
      timeout: 45s
      interval: 10s
      retries: 5
  fireflydb:
    image: mariadb:latest@sha256:3a24e9e99882a6848c5793f36ec7a730a8d301c5175613cd22a341fc039bd10a
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_USER: "{{ fireflydb.username }}"
      MYSQL_PASSWORD: "{{ fireflydb.password }}"
      MYSQL_DATABASE: "{{ fireflydb.database }}"
    volumes:
      - "{{ docker_volume_dirs[1] }}:/var/lib/mysql"
    networks:
      - "firefly"
  data_importer:
    image: fireflyiii/data-importer:latest@sha256:5cb61a152631f298b87ef003c973c16018445150644c08bf25fb8adff219297c
    environment:
      FIREFLY_III_ACCESS_TOKEN: "{{ data_importer.firefly_access_token }}"
      FIREFLY_III_URL: "http://firefly:{{ firefly.port }}"
      VANITY_URL: "https://firefly.{{ domain }}"
      EXPECT_SECURE_URL: "true"
      TRUSTED_PROXIES: "*"
    depends_on:
      - "firefly"
    networks:
      - "firefly"
      - "web"
    ports:
      - "{{ data_importer.port }}:8080"
    restart: "always"
    healthcheck:
      test: ["CMD", "curl", "https://healthchecks.{{ domain }}/ping/{{ data_importer.healthcheck }}"]
      timeout: 45s
      interval: 10s
      retries: 5
  plaid_connector:
    image: registry.gitlab.com/georgehahn/firefly-plaid-connector:latest@sha256:325a77dcca0a764a1aff1d658890532d35c37f734133accbddf3b3c96499c7e1
    volumes:
      - "{{ docker_volume_dirs[2] }}:/config"
    depends_on:
      - "firefly"
    networks:
      - "firefly"
    restart: "always"
    healthcheck:
      test: ["CMD", "curl", "https://healthchecks.{{ domain }}/ping/{{ plaid.healthcheck }}"]
      timeout: 45s
      interval: 10s
      retries: 5
networks:
  firefly:
    attachable: "true"
  web:
    external: "true"
