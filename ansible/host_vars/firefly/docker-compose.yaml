---
version: "3.8"
services:
  firefly:
    image: fireflyiii/core:latest@sha256:4ad204ece837cef2f3763f93f5230093dad11a20e5dd92f3d6b3d8d6163a6a98
    volumes:
      - "{{ docker_volume_dirs.firefly[0] }}:/var/www/html/storage/upload"
    environment:
      SITE_OWNER: "{{ firefly.site_owner }}"
      APP_KEY: "{{ firefly.app_key }}"
      TRUSTED_PROXIES: "{{ firefly.trusted_proxies }}"
      DB_CONNECTION: mysql
      DB_HOST: fireflydb
      DB_PORT: "{{ fireflydb.port }}"
      DB_DATABASE: "{{ fireflydb.database }}"
      DB_USERNAME: "{{ fireflydb.username }}"
      DB_PASSWORD: "{{ fireflydb.password }}"
      COOKIE_DOMAIN: "{{ domain }}"
      MAIL_MAILER: log
      MAIL_HOST: "{{ firefly.mail.host }}"
      MAIL_PORT: "{{ firefly.mail.port }}"
      MAIL_FROM: "{{ firefly.mail.from }}"
      MAIL_USERNAME: "{{ firefly.mail.username }}"
      MAIL_PASSWORD: "{{ firefly.mail.password }}"
      MAIL_ENCRYPTION: "{{ firefly.mail.encryption }}"
      SEND_REGISTRATION_MAIL: "{{ firefly.mail.send_registration }}"
      APP_NAME: FireflyIII
      APP_URL: http://localhost
    depends_on:
      - fireflydb
    networks:
      - firefly
      - web
    ports:
      - "{{ firefly.port }}:8080"
    restart: always
    healthcheck:
      test: [CMD, curl, "{{ healthchecks.healthcheck }}"]
      timeout: 45s
      interval: "{{ healthchecks_defaults.ping.interval }}s"
      retries: 5
  fireflydb:
    image: mariadb:latest@sha256:1c33370a599c870eab28891191b1fc5f46ddf8dfd90bd5f56b03e8a16e83f2fb
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_USER: "{{ fireflydb.username }}"
      MYSQL_PASSWORD: "{{ fireflydb.password }}"
      MYSQL_DATABASE: "{{ fireflydb.database }}"
    volumes:
      - "{{ docker_volume_dirs.fireflydb[0] }}:/var/lib/mysql"
    networks:
      - firefly
  data_importer:
    image: fireflyiii/data-importer:latest@sha256:322d9471a07a3b37a1d486357a975a6201cb5db2daa1f84ac81e362d49dbcfe0
    environment:
      FIREFLY_III_ACCESS_TOKEN: "{{ data_importer.firefly_access_token }}"
      FIREFLY_III_URL: http://firefly:{{ firefly.port }}
      VANITY_URL: https://firefly.{{ domain }}
      EXPECT_SECURE_URL: "true"
      TRUSTED_PROXIES: "*"
    depends_on:
      - firefly
    networks:
      - firefly
      - web
    ports:
      - "{{ data_importer.port }}:8080"
    restart: always
    healthcheck:
      test: [CMD, curl, "{{ healthchecks.healthcheck }}"]
      timeout: 45s
      interval: "{{ healthchecks_defaults.ping.interval }}s"
      retries: 5
  plaid_connector:
    image: registry.gitlab.com/georgehahn/firefly-plaid-connector:latest@sha256:325a77dcca0a764a1aff1d658890532d35c37f734133accbddf3b3c96499c7e1
    volumes:
      - "{{ docker_volume_dirs.plaid[0] }}:/config"
    depends_on:
      - firefly
    networks:
      - firefly
    restart: always
    healthcheck:
      test: [CMD, curl, "{{ healthchecks.healthcheck }}"]
      timeout: 45s
      interval: "{{ healthchecks_defaults.ping.interval }}s"
      retries: 5
  promtail:
    image: grafana/promtail:latest@sha256:762bc5be21174c50c636cf53e4c94bacf940488a803edb3e3018f6d0dd09df57
    restart: always
    volumes:
      - /var/log/cloudflared.log:/var/log/cloudflared.log:ro
      - /var/log/journal:/var/log/journal:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{ docker_volume_dirs.promtail[0] }}/config.yaml:/etc/promtail/config.yaml"
    command: -config.file=/etc/promtail/config.yaml

networks:
  firefly:
    attachable: true
  web:
    external: true
