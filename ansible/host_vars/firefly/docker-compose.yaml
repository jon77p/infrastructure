---
version: "3.8"
services:
  firefly:
    image: fireflyiii/core:latest@sha256:70356f5dcd0ea3076369ff7a18e9760253283d02e12041884af9b29cc73d3edc
    volumes:
      - "{{ docker_volume_dirs.firefly[0] }}:/var/www/html/storage/upload"
    environment:
      SITE_OWNER: "{{ firefly.site_owner }}"
      APP_KEY: "{{ firefly.app_key }}"
      TRUSTED_PROXIES: "{{ firefly.trusted_proxies }}"
      DB_CONNECTION: mysql
      DB_HOST: fireflydb
      DB_PORT: "{{ fireflydb.port }}"
      DB_DATABASE: "{{ fireflydb.database }}"
      DB_USERNAME: "{{ fireflydb.username }}"
      DB_PASSWORD: "{{ fireflydb.password }}"
      COOKIE_DOMAIN: "{{ domain }}"
      MAIL_MAILER: log
      MAIL_HOST: "{{ firefly.mail.host }}"
      MAIL_PORT: "{{ firefly.mail.port }}"
      MAIL_FROM: "{{ firefly.mail.from }}"
      MAIL_USERNAME: "{{ firefly.mail.username }}"
      MAIL_PASSWORD: "{{ firefly.mail.password }}"
      MAIL_ENCRYPTION: "{{ firefly.mail.encryption }}"
      SEND_REGISTRATION_MAIL: "{{ firefly.mail.send_registration }}"
      APP_NAME: FireflyIII
      APP_URL: http://localhost
    depends_on:
      - fireflydb
    networks:
      - firefly
      - web
    ports:
      - "{{ firefly.port }}:8080"
    restart: always
    healthcheck:
      test: [CMD, curl, "https://healthchecks.{{ domain }}/ping/{{ firefly.healthcheck }}"]
      timeout: 45s
      interval: 10s
      retries: 5
  fireflydb:
    image: mariadb:latest@sha256:a98834606bea049d3094d0d90964eb749d9a10c46f60e58e67ca75a6a155c1ad
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_USER: "{{ fireflydb.username }}"
      MYSQL_PASSWORD: "{{ fireflydb.password }}"
      MYSQL_DATABASE: "{{ fireflydb.database }}"
    volumes:
      - "{{ docker_volume_dirs.fireflydb[0] }}:/var/lib/mysql"
    networks:
      - firefly
  data_importer:
    image: fireflyiii/data-importer:latest@sha256:2024b428fbba4885848e6a67f3e4fb39c279ec80bcde887ec0718a5ba6219d42
    environment:
      FIREFLY_III_ACCESS_TOKEN: "{{ data_importer.firefly_access_token }}"
      FIREFLY_III_URL: http://firefly:{{ firefly.port }}
      VANITY_URL: https://firefly.{{ domain }}
      EXPECT_SECURE_URL: "true"
      TRUSTED_PROXIES: "*"
    depends_on:
      - firefly
    networks:
      - firefly
      - web
    ports:
      - "{{ data_importer.port }}:8080"
    restart: always
    healthcheck:
      test: [CMD, curl, "https://healthchecks.{{ domain }}/ping/{{ data_importer.healthcheck }}"]
      timeout: 45s
      interval: 10s
      retries: 5
  plaid_connector:
    image: registry.gitlab.com/georgehahn/firefly-plaid-connector:latest@sha256:325a77dcca0a764a1aff1d658890532d35c37f734133accbddf3b3c96499c7e1
    volumes:
      - "{{ docker_volume_dirs.plaid[0] }}:/config"
    depends_on:
      - firefly
    networks:
      - firefly
    restart: always
    healthcheck:
      test: [CMD, curl, "https://healthchecks.{{ domain }}/ping/{{ plaid.healthcheck }}"]
      timeout: 45s
      interval: 10s
      retries: 5
  promtail:
    image: grafana/promtail:latest@sha256:c16c710f7333411a1a788842ec9967e26577053ff0c0dff41a8d9a6ea0b95c2b
    restart: always
    volumes:
      - /var/log/cloudflared.log:/var/log/cloudflared.log:ro
      - /var/log/journal:/var/log/journal:ro
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - "{{ docker_volume_dirs.promtail[0] }}/config.yaml:/etc/promtail/config.yaml"
    command: -config.file=/etc/promtail/config.yaml

networks:
  firefly:
    attachable: true
  web:
    external: true
