---
version: '3'
services:
  nextclouddb:
    image: mariadb:latest@sha256:3a24e9e99882a6848c5793f36ec7a730a8d301c5175613cd22a341fc039bd10a
    restart: always
    command: --transaction-isolation=READ-COMMITTED --log-bin=mysqld-bin --binlog-format=ROW --innodb-file-per-table=1 --skip-innodb-read-only-compressed
    environment:
      MYSQL_RANDOM_ROOT_PASSWORD: "yes"
      MYSQL_USER: "{{ mysql.username }}"
      MYSQL_PASSWORD: "{{ mysql.password }}"
      MYSQL_DATABASE: "{{ mysql.database }}"
    volumes:
      - "{{ docker_volume_dirs.nextclouddb[0] }}:/var/lib/mysql"
    networks:
      - "nextcloud"
  nextcloud:
    image: nextcloud:latest@sha256:f832bb0a0c3df2ae66e8156dedc0ca8d79259d5355be8a90cc4342a9655a235a
    volumes:
      - "{{ docker_volume_dirs.nextcloud[0] }}:/var/www/html"
      - "{{ docker_volume_dirs.nextcloud[1] }}:/var/www/html/data"
    ports:
      - "{{ compose_project_port }}:80"
    environment:
      PUID: "{{ rclone_mount_uid }}"
      PGID: "{{ rclone_mount_gid }}"
      MYSQL_HOST: "nextclouddb"
      MYSQL_DATABASE: "{{ mysql.database }}"
      MYSQL_USER: "{{ mysql.username }}"
      MYSQL_PASSWORD: "{{ mysql.password }}"
      MAIL_FROM_ADDRESS: "nextcloud"
      MAIL_DOMAIN: "{{ cloudflare_dns_records[0].record }}"
      SMTP_HOST: "{{ nextcloud.smtp.host }}"
      SMTP_PORT: "{{ nextcloud.smtp.port }}"
      SMTP_NAME: "{{ nextcloud.smtp.username }}"
      SMTP_PASSWORD: "{{ nextcloud.smtp.password }}"
      SMTP_SECURE: "{{ nextcloud.smtp.secure }}"
      NEXTCLOUD_ADMIN_USER: "{{ nextcloud.admin.username }}"
      NEXTCLOUD_ADMIN_PASSWORD: "{{ nextcloud.admin.password }}"
      NEXTCLOUD_TRUSTED_DOMAINS: "{{ cloudflare_dns_records[0].record }}"
      OVERWRITEPROTOCOL: "https"
      OVERWRITEHOST: "{{ cloudflare_dns_records[0].record }}"
    networks:
      - "nextcloud"
      - "web"
    restart: "always"
    healthcheck:
      test: ["CMD", "curl", "https://healthchecks.{{ domain }}/ping/{{ nextcloud.healthcheck }}"]
      timeout: 45s
      interval: 10s
      retries: 5
  promtail:
    image: grafana/promtail:latest
    restart: "always"
    volumes:
      - "/var/log/cloudflared.log:/var/log/cloudflared.log:ro"
      - "/var/log/journal:/var/log/journal:ro"
      - "/var/run/docker.sock:/var/run/docker.sock:ro"
      - "{{ docker_volume_dirs.promtail[0] }}/config.yaml:/etc/promtail/config.yaml"
    command: "-config.file=/etc/promtail/config.yaml"
  node_exporter:
    image: quay.io/prometheus/node-exporter:latest
    restart: "always"
    ports:
      - "{{ node_exporter.port }}:{{ node_exporter.internal_port }}"
    command:
      - "--path.rootfs=/host"
      - "--collector.systemd"
      - "--collector.processes"
    pid: host
    volumes:
      - "/:/host:ro,rslave"
  cadvisor:
    image: zcube/cadvisor:latest
    restart: "always"
    ports:
      - "{{ cadvisor.port }}:{{ cadvisor.internal_port }}"
    volumes:
      - /:/rootfs:ro
      - /var/run:/var/run:rw
      - /sys:/sys:ro
      - /var/lib/docker/:/var/lib/docker:ro

networks:
  nextcloud:
    attachable: "true"
  web:
    external: "true"
