- name: Check if innernet network is created
  stat:
    path: /etc/innernet-server/{{ innernet_network }}.conf
  register: innernet_server_check_network

- name: Create new network
  shell: innernet-server new --network-name {{ innernet_network }} --network-cidr {{ innernet_network_cidr }} --auto-external-endpoint --listen-port {{ innernet_server_port }}
  when: not innernet_server_check_network.stat.exists

- name: Enable new network
  systemd:
    name: innernet-server@{{ innernet_network }}
    state: started
    daemon_reload: yes
    enabled: yes

- name: Add cluster CIDR
  shell: innernet-server add-cidr --name {{ cluster_network_name }} --cidr {{ cluster_network_cidr }} --parent {{ cluster_network_parent }} --yes {{ innernet_network }}
  when: not innernet_server_check_network.stat.exists
