- name: Check if innernet-server is installed
  become: true
  command: dpkg-query -W innernet-server
  register: innernet_server_check_deb
  failed_when: innernet_server_check_deb.rc > 1
  changed_when: innernet_server_check_deb.rc == 1

- name: Download innernet-server .deb
  get_url:
    url: https://github.com/tonarino/innernet/releases/download/v1.5.0/innernet-server_1.5.0_amd64.deb
    dest: /tmp/innernet-server_1.5.0_amd64.deb
  when: innernet_server_check_deb.rc == 1

- name: Install innernet-server
  become: true
  apt:
    deb: /tmp/innernet-server_1.5.0_amd64.deb
  when: innernet_server_check_deb.rc == 1

- name: Check if innernet network is created
  become: true
  stat:
    path: /etc/innernet-server/{{ innernet_network }}.conf
  register: innernet_server_check_network

- name: Create new network
  become: true
  shell: innernet-server new --network-name {{ innernet_network }} --network-cidr {{ innernet_network_cidr }} --auto-external-endpoint --listen-port {{ innernet_server_port }}
  when: not innernet_server_check_network.stat.exists

- name: Add additional CIDRs
  become: true
  shell: innernet-server add-cidr --name {{ item.network_name }} --cidr {{ item.network_cidr }} --parent {{ item.network_parent }} --yes {{ innernet_network }}
  register: result
  changed_when: result.rc == 0
  ignore_errors: true # no easy way to check if CIDR already exists
  loop: "{{ additional_networks }}"

- name: Enable new network
  become: true
  systemd:
    name: innernet-server@{{ innernet_network }}
    state: restarted
    enabled: yes
