---
- name: Install innernet-server
  ansible.builtin.include_tasks: innernet-server-install.yml

- name: Check if innernet network is created
  become: true
  ansible.builtin.stat:
    path: /etc/innernet-server/{{ innernet_network }}.conf
  register: innernet_server_check_network

- name: Create new network
  become: true
  ansible.builtin.command: |
    innernet-server new
    --network-name {{ innernet_network }}
    --network-cidr {{ innernet_network_cidr }}
    --auto-external-endpoint
    --listen-port {{ innernet_server_port }}
  when: not innernet_server_check_network.stat.exists

- name: Add additional CIDRs
  become: true
  ansible.builtin.command: |
    innernet-server add-cidr
    --name {{ innernet_additional_network.network_name }}
    --cidr {{ innernet_additional_network.network_cidr }}
    --parent {{ innernet_additional_network.network_parent }}
    --yes {{ innernet_network }}
  register: result
  changed_when: result.rc == 0
  ignore_errors: true # no easy way to check if CIDR already exists
  loop: "{{ additional_networks }}"
  loop_control:
    loop_var: innernet_additional_network

- name: Enable new network
  become: true
  ansible.builtin.systemd:
    name: innernet-server@{{ innernet_network }}
    state: restarted
    daemon-reload: true
    enabled: true
