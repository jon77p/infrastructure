---
- name: Innernet | Create /etc/innernet-server/peers directory
  become: true
  file:
    path: /etc/innernet-server/peers
    state: directory

- name: Innernet | Check if invite has been created for peer {{ peer.name }}
  become: true
  stat:
    path: /etc/innernet-server/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml
  register: innernet_invite_peer_check

- name: Innernet | add peer {{ peer.name }} with auto-ip
  become: true
  shell: innernet-server add-peer --name {{ peer.name }} --auto-ip --cidr {{ peer.cidr }} --admin {{ peer.admin | default("false") }} --save-config /etc/innernet-server/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml --yes {{ innernet_network }}
  when: not innernet_invite_peer_check.stat.exists and peer.ip is not defined

- name: Innernet | add peer {{ peer.name }} with manual ip
  become: true
  shell: innernet-server add-peer --name {{ peer.name }} --ip {{ peer.ip }} --cidr {{ peer.cidr }} --admin {{ peer.admin | default("false") }} --save-config /etc/innernet-server/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml --yes {{ innernet_network }}
  when: not innernet_invite_peer_check.stat.exists and peer.ip is defined

- name: Innernet | Fetch invite invite-{{ peer.name }}-{{ peer.cidr }}.toml from innernet-server
  become: true
  fetch:
    src: /etc/innernet-server/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml
    dest: ../secrets/invite-{{ peer.name }}-{{ peer.cidr }}.toml
    flat: yes
  when: not innernet_invite_peer_check.stat.exists
