---
- name: Check if cargo is installed
  become: true
  stat:
    path: "{{ cargo_path }}/bin/cargo"
  register: cargo_check

- name: Install build utils
  become: true
  apt:
    state: latest
    pkg:
      - git
      - clang
      - libclang-dev
      - libsqlite3-dev
      - llvm

- name: Install cargo
  become: true
  shell: curl https://sh.rustup.rs -sSf | sh -s -- -y
  when: not cargo_check.stat.exists

- name: Check if innernet is installed
  become: true
  stat:
    path: "{{ cargo_path }}/bin/{{ innernet_binary }}"
  register: innernet_check

- name: "Install innernet - {{ innernet_program_type }}"
  become: true
  shell: "{{ cargo_path }}/bin/cargo install --git https://github.com/tonarino/innernet --tag v{{ innernet_version }} {{ innernet_program_type }}"
  when: not innernet_check.stat.exists

- name: "Symlink {{ innernet_binary }} into /usr/bin/"
  become: true
  file:
    src: "{{ cargo_path }}/bin/{{ innernet_binary }}"
    dest: "/usr/bin/{{ innernet_binary }}"
    state: link

- name: "Create necessary {{ innernet_binary }} service"
  include_tasks: "innernet-install-service.yml"
