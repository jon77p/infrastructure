- name: Innernet | Check if invite has been created for {{ peer_name }}
  stat:
    path: /tmp/invite-{{ peer_name }}.toml
  register: innernet_invite_peer_check

- name: Innernet | add peer
  become: true
  shell: innernet-server add-peer --name {{ peer_name }} --auto-ip --cidr {{ cluster_network_name }} --admin false --yes --save-config /tmp/invite-{{ peer_name }}.toml {{ innernet_network }}
  when: not innernet_invite_peer_check.stat.exists

- name: Innernet | Fetch invite for {{ peer_name }} from innernet-server
  become: true
  fetch:
    src: /tmp/invite-{{ peer_name }}.toml
    dest: ./invite-{{ peer_name }}.toml
    flat: yes
  when: not innernet_invite_peer_check.stat.exists

- name: Innernet | Remove invite for {{ peer_name }} from innernet-server
  become: true
  file:
    path: /tmp/invite-{{ peer_name }}.toml
    state: absent
  when: not innernet_invite_peer_check.stat.exists

- name: Innernet | Restart innernet-server
  become: true
  systemd:
    name: innernet-server@{{ innernet_network }}
    state: restarted
  when: not innernet_invite_peer_check.stat.exists
