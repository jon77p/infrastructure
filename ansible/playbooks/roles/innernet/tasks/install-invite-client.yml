---
- name: Innernet | Check if network has been added for peer
  become: true
  stat:
    path: /etc/innernet/{{ innernet_network }}.conf
  register: innernet_network_check

- name: Innernet | Create /etc/innernet/peers directory
  become: true
  file:
    path: /etc/innernet/peers
    state: directory

- name: Innernet | Check that invite has been transferred to peer
  become: true
  stat:
    path: /etc/innernet/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml
  register: innernet_invite_check

- name: Innernet | Copy invite from host to peer
  become: true
  copy:
    src: ../secrets/invite-{{ peer.name }}-{{ peer.cidr }}.toml
    dest: /etc/innernet/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml
  when: not innernet_network_check.stat.exists and not innernet_invite_check.stat.exists

- name: Innernet | add peer
  become: true
  shell: innernet install --default-name /etc/innernet/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml
  when: not innernet_network_check.stat.exists

- name: Innernet | Enable new network
  become: true
  systemd:
    name: innernet@{{ innernet_network }}
    state: restarted
    enabled: yes
    daemon-reload: yes
  when: not innernet_network_check.stat.exists
