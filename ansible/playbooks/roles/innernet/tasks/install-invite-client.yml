---
- name: Innernet | Check if network has been added for peer
  become: true
  ansible.builtin.stat:
    path: /etc/innernet/{{ innernet_network }}.conf
  register: innernet_network_check

- name: Innernet | Create /etc/innernet/peers directory
  when: not innernet_network_check.stat.exists
  become: true
  ansible.builtin.file:
    path: /etc/innernet/peers
    state: directory

- name: Innernet | Check that invite has been transferred to peer
  when: not innernet_network_check.stat.exists
  become: true
  ansible.builtin.stat:
    path: /etc/innernet/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml
  register: innernet_invite_check

- name: Innernet | Copy invite from host to peer
  become: true
  ansible.builtin.copy:
    src: ../secrets/invite-{{ peer.name }}-{{ peer.cidr }}.toml
    dest: /etc/innernet/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml
  when: not innernet_network_check.stat.exists and not innernet_invite_check.stat.exists

- name: Innernet | add peer
  become: true
  ansible.builtin.command: |
    innernet install
    --default-name
    --hosts-path /etc/hosts
    --delete-invite
    /etc/innernet/peers/invite-{{ peer.name }}-{{ peer.cidr }}.toml
  when: not innernet_network_check.stat.exists

- name: Innernet | Enable new network
  become: true
  ansible.builtin.systemd:
    name: innernet@{{ innernet_network }}
    state: restarted
    enabled: true
    daemon-reload: true

- name: Innernet | Take down wireguard interface (part 1/2 of /etc/hosts refresh)
  become: true
  ansible.builtin.command: innernet down {{ innernet_network }}

- name: Innernet | Bring back up wireguard interface (part 2/2 of /etc/hosts refresh)
  become: true
  ansible.builtin.command: innernet up {{ innernet_network }}
