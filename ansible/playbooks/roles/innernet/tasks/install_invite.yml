- name: Innernet | Check if network has been added for {{ peer_name }}
  become: true
  stat:
    path: /etc/innernet/{{ innernet_network }}.conf
  register: innernet_network_check

- name: Innernet | Check that invite has been transferred to {{ peer_name }}
  stat:
    path: /tmp/invite-{{ peer_name }}.toml
  register: innernet_invite_check

- name: Innernet | Copy invite from host to {{ peer_name }}
  copy:
    src: ./invite-{{ peer_name }}.toml
    dest: /tmp/invite-{{ peer_name }}.toml
  when: not innernet_network_check.stat.exists and not innernet_invite_check.stat.exists

- name: Innernet | add peer
  become: true
  shell: innernet install --default-name --delete-invite /tmp/invite-{{ peer_name }}.toml
  when: not innernet_network_check.stat.exists

- name: Innernet | Enable new network
  become: true
  systemd:
    name: innernet@{{ innernet_network }}
    state: started
    enabled: yes
  when: not innernet_network_check.stat.exists
