---
- name: Include service variables
  ansible.builtin.include_vars: service.yml
- name: Include helm variables
  ansible.builtin.include_vars: helm.yml

- name: Create the namespace {{ item }}
  loop: "{{ namespaces }}"
  kubernetes.core.k8s:
    state: present
    name: "{{ item }}"
    api_version: v1
    kind: Namespace

- name: Create the secrets {{ item.metadata.name }}
  loop: "{{ secrets }}"
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"

- name: Setup helm deployment
  when: helm != None and helm is defined
  ansible.builtin.include_tasks: helm.yml

- name: Create the deployment {{ item.metadata.name }}
  loop: "{{ deployments }}"
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"

- name: Create the service {{ item.metadata.name }}
  loop: "{{ services }}"
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"

- name: Create the ingress {{ item.metadata.name }}
  loop: "{{ ingress }}"
  kubernetes.core.k8s:
    state: present
    definition: "{{ item }}"

- name: Create the resource {{ item.metadata.name ~ " " ~ item.kind }}
  loop: "{{ additional_resources }}"
  kubernetes.core.k8s:
    state: present
    force: true
    definition: "{{ item }}"

- name: Create any additional records
  vars:
    cloudflare_dns_records: "{{ hostvars[servicename].cloudflare_dns_records | default([]) }}"
  ansible.builtin.include_role:
    name: cloudflare
