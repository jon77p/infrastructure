- name: Check if k3s is installed
  stat:
    path: /usr/local/bin/k3s
  register: k3s_check

- name: Install k3s
  when: not k3s_check.stat.exists
  shell: curl -sfL https://get.k3s.io | sh -

- name: Add Traefik Pilot and ingress config
  template:
    src: ../templates/traefik-config.yaml.j2
    dest: /var/lib/rancher/k3s/server/manifests/traefik-config.yaml

- name: Retrieve node token
  shell: cat /var/lib/rancher/k3s/server/node-token
  register: nodetoken

- name: Store node token in dummy host
  add_host:
    name: "K3S_TOKEN_HOLDER"
    token: "{{ nodetoken.stdout }}"
    manager: "{{ ansible_hostname }}"

- debug:
    var: hostvars['K3S_TOKEN_HOLDER']['token']

- name: Fetch kubeconfig from manager
  run_once: true
  fetch:
    src: "/etc/rancher/k3s/k3s.yaml"
    dest: "{{ repo_abs_path.stdout }}/ansible/kubeconfig"
    flat: true

- name: Update kubeconfig to use manager hostname
  delegate_to: localhost
  become: false
  run_once: true
  replace:
    path: "{{ repo_abs_path.stdout }}/ansible/kubeconfig"
    regexp: "https://127.0.0.1:6443"
    replace: "https://{{ ansible_hostname }}:6443"
