---
- name: Ensure all volume mounts exist
  vars:
    directories: "{{ docker_volume_dirs }}"
  include_tasks: volume-mounts-{{ docker_volume_dirs | type_debug }}.yml

- name: Load project definition for host
  include_vars:
    file: ../../../../host_vars/{{ inventory_hostname }}/docker-compose.yaml
    name: compose_definition

- name: Take down {{ compose_project_name }} project
  community.docker.docker_compose:
    project_name: "{{ compose_project_name }}"
    definition: "{{ compose_definition }}"
    remove_orphans: true
    remove_images: all
    state: absent

- name: Create any referenced Compose networks
  community.docker.docker_network:
    name: "{{ item.name }}"
    attachable: "{{ item.attachable }}"
    internal: "{{ item.internal }}"
  loop: "{{ compose_network_names }}"

- name: Deploy docker-compose for {{ compose_project_name }} project
  community.docker.docker_compose:
    project_name: "{{ compose_project_name }}"
    definition: "{{ compose_definition }}"
    timeout: 60
  register: output

- debug:
    var: output.services

- name: Wait for services to start
  pause:
    seconds: 30

- ansible.builtin.assert:
    that:
      - output.services.{{ item.key }}.{{ compose_project_name }}_{{ item.key }}_1.state.running
  loop: "{{ compose_definition.services | dict2items }}"
