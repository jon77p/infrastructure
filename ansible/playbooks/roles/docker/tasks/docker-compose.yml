- name: Ensure all volume mounts exist
  become: true
  when: "docker_volume_dir != None"
  file:
    path: "{{ docker_volume_dir }}"
    state: directory

- name: Take down {{ compose_project_name }} project
  community.docker.docker_compose:
    project_name: "{{ compose_project_name }}"
    definition: "{{ compose_definition }}"
    remove_orphans: true
    remove_images: "all"
    state: absent

- name: Deploy docker-compose for {{ compose_project_name }} project
  community.docker.docker_compose:
    project_name: "{{ compose_project_name }}"
    definition: "{{ compose_definition }}"
  register: output

- debug:
    var: output

- ansible.builtin.assert:
    that:
      - "output.services.{{ compose_project_name }}.{{ compose_project_name }}_{{ item.key }}_1.state.running"
  loop: "{{ compose_definition.services | dict2items }}"
