---
- name: Check if code is installed
  become_user: "{{ ansible_ssh_user }}"
  ansible.builtin.command: code --version
  register: code_status
  ignore_errors: true

- name: Install VS Code
  include_tasks: install.yml
  when: code_status.rc != 0

- name: Check if code-tunnel is logged in
  become_user: "{{ ansible_ssh_user }}"
  ansible.builtin.command: code tunnel user show
  register: tunnel_status

- name: Login to code tunnel and wait for user approval
  become_user: "{{ ansible_ssh_user }}"
  when: tunnel_status.stdout == "not logged in"
  async: 300
  poll: 0
  ansible.builtin.shell: code tunnel user login --provider github 2>&1 | tee /tmp/code-tunnel-login.log
  register: login_progress

- name: Wait 10 seconds for code-tunnel login to start
  when: tunnel_status.stdout == "not logged in"
  ansible.builtin.wait_for:
    timeout: 10

- name: Get code-tunnel output
  become_user: "{{ ansible_ssh_user }}"
  when: tunnel_status.stdout == "not logged in"
  ansible.builtin.shell: cat /tmp/code-tunnel-login.log
  delay: 10
  register: tunnel_login_output

- name: Print code-tunnel output
  ansible.builtin.debug:
    msg: "{{ tunnel_login_output.stdout }}"
  when: tunnel_status.stdout == "not logged in"

- name: Wait for login to complete
  become_user: "{{ ansible_ssh_user }}"
  when: tunnel_status.stdout == "not logged in"
  ansible.builtin.async_status:
    jid: "{{ login_progress.ansible_job_id }}"
  register: login_status
  until: login_status.finished
  retries: 10
  delay: 10

- name: Verify code-tunnel is now logged in
  become_user: "{{ ansible_ssh_user }}"
  ansible.builtin.command: code tunnel user show
  register: verify_tunnel_status
  failed_when: verify_tunnel_status.stdout == "not logged in"
  when: tunnel_status.stdout == "not logged in"

- name: Create license_consent.json file
  ansible.builtin.copy:
    content: '{"consented":true}'
    dest: /home/{{ ansible_ssh_user }}/.vscode-cli/license_consent.json
    owner: "{{ ansible_ssh_user }}"
    group: "{{ ansible_ssh_user }}"
    mode: 0644

- name: Check if tunnel has been named correctly
  become_user: "{{ ansible_ssh_user }}"
  # Line is in format of "name":"<tunnel-name>" in ~/.vscode-cli/code_tunnel.json
  ansible.builtin.shell: grep -q '"name":"{{ code.tunnel }}"' /home/{{ ansible_ssh_user }}/.vscode-cli/code_tunnel.json
  ignore_errors: true
  register: tunnel_name_status

- name: Rename tunnel
  become_user: "{{ ansible_ssh_user }}"
  when: tunnel_name_status.rc != 0
  ansible.builtin.shell: code tunnel rename {{ code.tunnel }}
  register: tunnel_rename_status

- name: Verify tunnel has been named correctly
  become_user: "{{ ansible_ssh_user }}"
  # Line is in format of "name":"<tunnel-name>" in ~/.vscode-cli/code_tunnel.json
  ansible.builtin.shell: grep -q '"name":"{{ code.tunnel }}"' /home/{{ ansible_ssh_user }}/.vscode-cli/code_tunnel.json
  register: verify_tunnel_name_status
  failed_when: verify_tunnel_name_status.rc != 0

- name: Install code-tunnel service
  become_user: "{{ ansible_ssh_user }}"
  ansible.builtin.shell:
    cmd: code tunnel service install
    creates: /home/{{ ansible_ssh_user }}/.vscode-cli/code-tunnel.service

- name: Create code-tunnel service in /etc/systemd/system
  ansible.builtin.command:
    cmd: ln -s /home/{{ ansible_ssh_user }}/.vscode-cli/code-tunnel.service /etc/systemd/system/code-tunnel.service
    creates: /etc/systemd/system/code-tunnel.service

- name: Update code-tunnel service to run as user
  # The User line does not exist in the default service file
  ansible.builtin.lineinfile:
    path: /etc/systemd/system/code-tunnel.service
    regexp: "^User="
    line: "User={{ ansible_ssh_user }}"
    insertafter: "^ExecStart="
    state: present
    create: yes

- name: Update code-tunnel service to run as group
  # The Group line does not exist in the default service file
  ansible.builtin.lineinfile:
    path: /etc/systemd/system/code-tunnel.service
    regexp: "^Group="
    line: "Group={{ ansible_ssh_user }}"
    insertafter: "^User="
    state: present
    create: yes

- name: Enable code-tunnel service
  ansible.builtin.systemd:
    name: code-tunnel
    enabled: true
    daemon_reload: true

- name: Restart code-tunnel service
  ansible.builtin.systemd:
    name: code-tunnel.service
    state: restarted
