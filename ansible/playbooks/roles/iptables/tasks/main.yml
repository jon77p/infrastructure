---
- name: Install iptables-persistent
  become: true
  ansible.builtin.apt:
    name: iptables-persistent
    state: latest

- name: Restore iptables rules if they exist
  become: true
  ansible.builtin.shell: iptables-restore /etc/iptables/rules.v4

- name: iptables update rules
  become: true
  iptables:
    action: "{{ item.action }}"
    chain: "{{ item.chain }}"
    rule_num: "{{ item.rule_num }}"
    ctstate: "{{ item.ctstate }}"
    destination_port: "{{ item.destination_port }}"
    protocol: "{{ item.protocol }}"
    state: "{{ item.state }}"
    jump: "{{ item.jump }}"
    comment: "{{ item.comment }}"
  loop: "{{ iptables_rules }}"

- name: Save iptables rules
  become: true
  ansible.builtin.shell: iptables-save -f /etc/iptables/rules.v4
