---
# Don't let DHCP4 set DNS servers (by using dhcp4-overrides in netplan)
- name: Disable DNS overrides
  become: true
  ansible.builtin.blockinfile:
    path: /etc/netplan/50-cloud-init.yaml
    insertafter: "(\\s*)set-name: (\\S+)"
    marker: "            # {mark} ANSIBLE MANAGED BLOCK"
    block: "            dhcp4-overrides:\n                use-dns: false\n"
  register: netplan_dhcp

- name: Apply new netplan
  become: true
  ansible.builtin.command: netplan apply
  async: 5
  poll: 1
  when: netplan_dhcp.changed

- name: Restart systemd-resolved
  become: true
  ansible.builtin.systemd:
    name: systemd-resolved
    state: restarted
