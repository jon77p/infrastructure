---
k3s:
  cert-manager:
    helm:
      name: "cert-manager"
      repo:
        name: "jetstack"
        url: "https://charts.jetstack.io"
      chart: "jetstack/cert-manager"
      namespace: "cert-manager"
      create_namespace: true
      chart_values:
        installCRDs: true
    additional_resources:
      - apiVersion: cert-manager.io/v1
        kind: ClusterIssuer
        metadata:
          name: cloudflare-issuer
          namespace: "cert-manager"
        spec:
          acme:
            email: "{{ cf_email }}"
            server: https://acme-v02.api.letsencrypt.org/directory
            privateKeySecretRef:
              name: prod-issuer-account-key
            solvers:
              - dns01:
                  cloudflare:
                    email: "{{ cf_email }}"
                    apiTokenSecretRef:
                      name: cloudflare-api-token
                      key: dns_api_token
                selector:
                  dnsZones:
                    - "{{ domain }}"
  whoami:
    namespaces:
      - "whoami"
    services:
      - apiVersion: v1
        kind: Service
        metadata:
          name: "whoami"
          namespace: "whoami"
        spec:
          ports:
            - name: "whoami"
              port: 80
              protocol: TCP
              targetPort: 80
          selector:
            app: "whoami"
    deployments:
      - kind: Deployment
        apiVersion: apps/v1
        metadata:
          labels:
            app: "whoami"
          name: "whoami"
          namespace: "whoami"
        spec:
          replicas: 1
          selector:
            matchLabels:
              app: "whoami"
          template:
            metadata:
              labels:
                app: "whoami"
            spec:
              containers:
                - name: "whoami"
                  image: traefik/whoami
                  ports:
                    - name: web
                      containerPort: 80
    ingress:
      - apiVersion: traefik.containo.us/v1alpha1
        kind: IngressRoute
        metadata:
          name: traefik
          namespace: kube-system
          annotations:
            cert-manager.io/cluster-issuer: cloudflare-issuer
        spec:
          entryPoints:
            - websecure
          routes:
          - match: Host(`traefik.{{ domain }}`)
            kind: Rule
            services:
              - name: api@internal
                kind: TraefikService
      - apiVersion: networking.k8s.io/v1
        kind: Ingress
        metadata:
          name: "whoami"
          namespace: "whoami"
          annotations:
            kubernetes.io/ingress.class: traefik
            traefik.ingress.kubernetes.io/router.entrypoints: websecure
            cert-manager.io/cluster-issuer: cloudflare-issuer
        spec:
          tls:
            - secretName: "whoami-tls"
              hosts:
                - "whoami.{{ domain }}"
          rules:
            - host: "whoami.{{ domain }}"
              http:
                paths:
                  - path: /
                    pathType: Prefix
                    backend:
                      service:
                        name: "whoami"
                        port:
                          number: 80
