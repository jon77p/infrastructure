version: "3.8"

services:
  cloudflared:
    image: visibilityspots/cloudflared:latest
    healthcheck:
      disable: true
    command: /usr/local/bin/cloudflared tunnel --no-autoupdate run --force
    configs:
      - source: cloudflared
        target: /etc/cloudflared/config.yml
    secrets:
      - source: cloudflared_cert
        target: /etc/cloudflared/cert.pem
    volumes:
      - /mnt/cloudflared:/etc/cloudflared
    networks:
      - web
    deploy:
      mode: global
      restart_policy:
        condition: any
        window: 60s
      placement:
        constraints:
          - node.role == manager

networks:
  web:
    external: true

configs:
  cloudflared:
    file: ./config.yml

secrets:
  cloudflared_cert:
    file: ./secrets/cert.pem
