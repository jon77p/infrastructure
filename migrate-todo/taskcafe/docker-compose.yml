version: "3.8"

services:
  taskcafe:
    image: ghcr.io/jon77p/taskcafe:latest@sha256:2a266a81be44bf7e6457ac509d7b755074dbbb79870d6052366b8d90978aeba9
    depends_on:
      - taskcafe-postgres
      - traefik
    env_file: secrets.env
    environment:
      TASKCAFE_DATABASE_HOST: taskcafe-postgres
      TASKCAFE_DATABASE_NAME: taskcafe
      TASKCAFE_MIGRATE: "true"
    networks:
      - taskcafe-internal
      - web
    deploy:
      restart_policy:
        condition: on-failure
      labels:
        traefik.enable: "true"
        traefik.docker.network: web
        traefik.http.routers.tasks.rule: Host(`tasks-cluster.${CF_DOMAIN}`)
        traefik.http.routers.tasks.entrypoints: https
        traefik.http.routers.tasks.tls.certresolver: cloudflare
        traefik.http.services.tasks.loadbalancer.server.port: 3333

  taskcafe-postgres:
    image: postgres:16.1-alpine@sha256:1aa9f8cf8c10f50489ff9f048b4a64c92292c59f51a2bb664693194c7d06b036
    volumes:
      - /mnt/taskcafe/postgres:/var/lib/postgresql/data
    env_file: secrets-postgres.env
    environment:
      POSTGRES_DB: taskcafe
    networks:
      - taskcafe-internal
    deploy:
      restart_policy:
        condition: on-failure

networks:
  taskcafe-internal:
    attachable: true
  web:
    external: true
