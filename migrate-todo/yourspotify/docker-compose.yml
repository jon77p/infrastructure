version: "3.8"

services:
  yourspotifyapp:
    image: yooooomi/your_spotify_server@sha256:18bf49a2fbbd083189d58ab45e7c25ad66d5d8f74b54801540a98c802f8a0ef3
    links:
      - yourspotifymongo
    depends_on:
      - yourspotifymongo
    env_file: secrets.env
    environment:
      - API_ENDPOINT=https://yourspotifyapp:8080
      - CLIENT_ENDPOINT=http://yourspotifyweb:3000
      - MONGO_ENDPOINT=mongodb://yourspotifymongo:27017/your_spotify
      # - CORS=http://yourspotifyweb:3000
      - CORS=all
    networks:
      - yourspotify
      - web
    deploy:
      restart_policy:
        condition: on-failure
      labels:
        traefik.enable: "true"
        traefik.docker.network: web
        traefik.http.routers.yourspotifyapi.rule: Path(`trends-spotify-cluster.${CF_DOMAIN}/api`)
        traefik.http.routers.yourspotifyapi.entrypoints: https
        traefik.http.routers.yourspotifyapi.tls.certresolver: cloudflare
        traefik.http.services.yourspotifyapi.loadbalancer.server.port: 8080

  yourspotifymongo:
    image: mongo:latest@sha256:946d309038b2581d8913213333eb3f86142d95e770ec6a3e334ca9b43ebd402e
    volumes:
      - /mnt/yourspotify/mongo:/data/db
    networks:
      - yourspotify
    deploy:
      restart_policy:
        condition: on-failure

  yourspotifyweb:
    image: yooooomi/your_spotify_client@sha256:93ec7f06ae1fad228b31380bb67391c33c823f2ccd0c15ce07c84d0e9e5b0fa5
    environment:
      - API_ENDPOINT=https://trends-spotify-cluster.${CF_DOMAIN}/api
    depends_on:
      - yourspotifyapp
      - traefik
    networks:
      - yourspotify
      - web
    deploy:
      restart_policy:
        condition: on-failure
      labels:
        traefik.enable: "true"
        traefik.docker.network: web
        traefik.http.routers.yourspotify.rule: Host(`trends-spotify-cluster.${CF_DOMAIN}`)
        traefik.http.routers.yourspotify.entrypoints: https
        traefik.http.routers.yourspotify.tls.certresolver: cloudflare
        traefik.http.services.yourspotify.loadbalancer.server.port: 3000

networks:
  yourspotify:
    attachable: true
  web:
    external: true
